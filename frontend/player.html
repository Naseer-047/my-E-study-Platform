<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classroom | Academia</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="../manifest.json">
    <meta name="theme-color" content="#06b6d4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: {
                        glass: { dark: 'rgba(15, 23, 42, 0.6)' },
                        neon: { blue: '#4F46E5', purple: '#A855F7', cyan: '#06B6D4' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #0b0f19; color: #e2e8f0; overflow: hidden; }
        .ambient-bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 10% 10%, rgba(79, 70, 229, 0.15), transparent 30%); }
        
        /* Custom Scrollbar for Glass */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .active-lesson {
            background: rgba(168, 85, 247, 0.1);
            border-left: 3px solid #A855F7;
        }
    </style>
</head>
<body class="flex flex-col h-screen">
    
    <div class="ambient-bg"></div>

    <!-- Top Bar -->
    <header class="h-16 border-b border-white/10 flex items-center justify-between px-6 bg-black/20 backdrop-blur-lg shrink-0 z-20">
        <div class="flex items-center gap-4">
            <a href="courses.html" class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center hover:bg-white/10 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4 text-gray-400"></i>
            </a>
            <span class="h-6 w-px bg-white/10"></span>
            <span id="course-title" class="font-display font-medium text-white tracking-wide">Loading...</span>
        </div>
        <div class="flex items-center gap-6">
            <div class="hidden sm:flex items-center gap-3 px-3 py-1.5 rounded-full bg-white/5 border border-white/5">
                <div class="w-6 h-6 rounded-full bg-neon-cyan/20 flex items-center justify-center text-[10px] font-bold text-neon-cyan" id="user-initials-player">--</div>
                <span class="text-xs font-medium text-gray-300" id="user-name-player">Student</span>
            </div>
            <button onclick="logoutStudent()" class="text-gray-500 hover:text-white transition-colors" title="Log Out">
                <i data-lucide="log-out" class="w-4 h-4"></i>
            </button>
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex-1 flex overflow-hidden">
        
        <!-- Sidebar Navigation (Syllabus) -->
        <aside class="w-80 border-r border-white/5 bg-black/20 backdrop-blur-md flex flex-col z-10 hidden md:flex">
             <div class="p-4 border-b border-white/5">
                <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Syllabus</h3>
            </div>
            <div id="playlist" class="flex-1 overflow-y-auto p-2 space-y-1">
                <!-- Injected Items -->
            </div>
        </aside>

        <!-- Stage -->
        <main class="flex-1 overflow-y-auto relative flex flex-col">
            
            <!-- Video Frame -->
            <div class="w-full bg-black aspect-video relative shadow-2xl flex items-center justify-center border-b border-white/10">
                 <div id="video-container" class="w-full h-full relative z-10">
                    <iframe id="youtube-player" class="w-full h-full" src="" frameborder="0" allowfullscreen></iframe>
                    <!-- Empty State -->
                    <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-black/80 backdrop-blur-sm z-20">
                        <div class="p-4 rounded-full bg-white/5 mb-4 animate-pulse"><i data-lucide="play" class="w-8 h-8 text-gray-500"></i></div>
                        <p class="font-display text-gray-400 tracking-wide">Select a module from the sidebar</p>
                    </div>
                 </div>
            </div>

            <!-- Content Deck -->
            <div class="p-4 md:p-8 max-w-5xl mx-auto w-full">
                
                <div class="flex flex-col md:flex-row justify-between items-start mb-8 pb-4 border-b border-white/5 gap-4">
                    <div>
                        <h1 id="lesson-title" class="text-3xl font-display font-bold text-white mb-2">Welcome</h1>
                        <p class="text-gray-400 text-sm">Watch the video to begin.</p>
                    </div>
                    <button id="download-notes-btn" onclick="downloadNotes()" class="hidden glass-panel px-4 py-2 rounded-lg text-sm font-medium hover:bg-neon-blue/20 hover:border-neon-blue/50 transition-all flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> Notes PDF
                    </button>
                </div>

                <!-- Tabs -->
                <div class="flex gap-6 border-b border-white/5 mb-8">
                    <button id="tab-notes" onclick="switchPlayerTab('notes')" class="pb-3 border-b-2 border-neon-cyan text-white text-sm font-medium transition-all">Lecture Notes</button>
                    <button id="tab-discussion" onclick="switchPlayerTab('discussion')" class="pb-3 border-b-2 border-transparent text-gray-500 hover:text-white transition-colors text-sm font-medium transition-all">Discussion</button>
                </div>

                <!-- Notes Content -->
                <div id="notes-content">
                    <div id="lesson-notes" class="prose prose-invert max-w-none prose-headings:font-display prose-a:text-neon-cyan">
                        <p class="text-gray-500 italic">No notes loaded.</p>
                    </div>
                </div>

                <!-- Discussion Content -->
                <div id="discussion-content" class="hidden">
                    <div class="space-y-6">
                        <div class="glass-panel p-6 rounded-xl border border-white/5">
                            <h4 class="text-white font-bold mb-4">Post a thought</h4>
                            <div class="space-y-4">
                                <input type="text" id="comm-name" placeholder="e.g. Priyanshu" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white text-sm outline-none focus:border-neon-purple transition-all">
                                <textarea id="comm-text" rows="2" placeholder="What's on your mind?" class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-white text-sm outline-none focus:border-neon-purple transition-all resize-none"></textarea>
                                <button onclick="postComment()" class="w-full bg-gradient-to-r from-neon-blue to-neon-purple text-white px-6 py-2 rounded-lg font-bold text-sm hover:scale-[1.02] active:scale-95 transition-all">Post Discussion</button>
                            </div>
                        </div>

                        <div id="comments-list" class="space-y-4">
                            <!-- Comments injected here -->
                        </div>
                    </div>
                </div>

            </div>
        </main>

    </div>

    <!-- Mobile Drawer Toggle -->
    <button id="mobile-menu-btn" class="md:hidden fixed bottom-6 right-6 w-14 h-14 bg-neon-purple rounded-full flex items-center justify-center shadow-lg shadow-neon-purple/30 z-50 text-white hover:scale-110 transition-transform">
        <i data-lucide="list-video" class="w-6 h-6"></i>
    </button>
    
    <!-- Mobile Slide Overlay -->
    <div id="mobile-sidebar-overlay" class="fixed inset-0 bg-black/80 z-20 hidden backdrop-blur-sm md:hidden" onclick="toggleMobileSidebar()"></div>

    <script>
        // Auth Guard
        if (!localStorage.getItem('studentToken')) {
            window.location.href = '../login.html';
        }

        const sidebar = document.querySelector('aside');
        const overlay = document.getElementById('mobile-sidebar-overlay');
        const btn = document.getElementById('mobile-menu-btn');
        
        function toggleMobileSidebar() {
            const isHidden = sidebar.classList.contains('hidden');
            if (isHidden) {
                // Open
                sidebar.classList.remove('hidden');
                sidebar.classList.add('fixed', 'inset-y-0', 'left-0', 'z-30', 'w-3/4', 'glass-panel');
                overlay.classList.remove('hidden');
            } else {
                // Close
                sidebar.classList.add('hidden');
                sidebar.classList.remove('fixed', 'inset-y-0', 'left-0', 'z-30', 'w-3/4', 'glass-panel');
                overlay.classList.add('hidden');
            }
        }
        
        btn.onclick = toggleMobileSidebar;
    </script>

    <script src="./js/config.js"></script>
    <script src="./js/notifications.js"></script>
    <script src="./js/player.js"></script>
    <script>
        lucide.createIcons();

        let currentVideoId = null;

        function switchPlayerTab(tab) {
            const notesContent = document.getElementById('notes-content');
            const discussionContent = document.getElementById('discussion-content');
            const btnNotes = document.getElementById('tab-notes');
            const btnDisc = document.getElementById('tab-discussion');

            if(tab === 'notes') {
                notesContent.classList.remove('hidden');
                discussionContent.classList.add('hidden');
                
                btnNotes.classList.add('border-neon-cyan', 'text-white');
                btnNotes.classList.remove('border-transparent', 'text-gray-500');
                
                btnDisc.classList.add('border-transparent', 'text-gray-500');
                btnDisc.classList.remove('border-neon-cyan', 'text-white');
            } else {
                notesContent.classList.add('hidden');
                discussionContent.classList.remove('hidden');
                
                btnDisc.classList.add('border-neon-cyan', 'text-white');
                btnDisc.classList.remove('border-transparent', 'text-gray-500');
                
                btnNotes.classList.add('border-transparent', 'text-gray-500');
                btnNotes.classList.remove('border-neon-cyan', 'text-white');
                
                loadComments();
            }
        }

        async function loadComments() {
            // Try to find video ID if null
            if(!currentVideoId) {
                const player = document.getElementById('youtube-player');
                if(player && player.src) {
                    const match = player.src.match(/embed\/([^?]+)/);
                    if(match) currentVideoId = match[1];
                }
            }

            if(!currentVideoId) return;
            const list = document.getElementById('comments-list');
            list.innerHTML = `<div class="text-center py-8 text-gray-500 animate-pulse text-xs">Loading discussion...</div>`;
            
            try {
                const res = await fetch(`${CONFIG.API_BASE_URL}/comments/${currentVideoId}`);
                if (!res.ok) throw new Error("API Error");
                const comments = await res.json();
                
                list.innerHTML = comments.length ? '' : `<div class="text-center py-12 text-gray-600 text-sm">No discussions yet. Be the first to start!</div>`;
                
                comments.forEach(c => {
                    const div = document.createElement('div');
                    div.className = "glass-panel p-4 rounded-xl border border-white/5 hover:bg-white/5 transition-colors mb-3";
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-neon-cyan font-bold text-xs uppercase tracking-wider">${c.userName}</span>
                            <span class="text-[9px] text-gray-600">${new Date(c.createdAt).toLocaleDateString()}</span>
                        </div>
                        <p class="text-gray-300 text-sm leading-relaxed">${c.text}</p>
                    `;
                    list.appendChild(div);
                });
            } catch(e) { 
                console.error(e); 
                list.innerHTML = `<div class="text-center py-8 text-neon-red/50 text-xs">Could not load discussions. Please try again.</div>`;
            }
        }

        async function postComment() {
            const nameEl = document.getElementById('comm-name');
            const textEl = document.getElementById('comm-text');
            const name = nameEl.value.trim();
            const text = textEl.value.trim();
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('id');

            if(!name || !text || !currentVideoId) return;

            try {
                const res = await fetch(`${CONFIG.API_BASE_URL}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        courseId,
                        videoId: currentVideoId,
                        userName: name,
                        text: text
                    })
                });

                if(res.ok) {
                    textEl.value = '';
                    loadComments();
                }
            } catch(e) { console.error(e); }
        }

        // Catch video changes from player.js
        const checkVideoTarget = setInterval(() => {
            const player = document.getElementById('youtube-player');
            if(player && player.src && player.src.includes('embed/')) {
                try {
                    const match = player.src.match(/embed\/([^?]+)/);
                    const vId = match ? match[1] : null;
                    if(vId && vId !== currentVideoId) {
                        currentVideoId = vId;
                        // Auto-refresh if currently on discussion tab
                        if(!document.getElementById('discussion-content').classList.contains('hidden')) {
                            loadComments();
                        }
                    }
                } catch(e) {}
            }
        }, 800);

        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('../sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Registration Failed', err));
            });
        }

        // User Info & Logout
        window.addEventListener('DOMContentLoaded', () => {
            const studentName = localStorage.getItem('studentName') || 'Student';
            const nameEl = document.getElementById('user-name-player');
            const initialEl = document.getElementById('user-initials-player');
            if(nameEl) nameEl.innerText = studentName;
            if(initialEl) initialEl.innerText = studentName.split(' ').map(n => n[0]).join('').toUpperCase();
        });

        function logoutStudent() {
            localStorage.removeItem('studentToken');
            localStorage.removeItem('studentName');
            window.location.href = '../login.html';
        }
    </script>
</body>
</html>
