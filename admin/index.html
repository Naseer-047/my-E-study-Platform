<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Academia</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="../frontend/js/config.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'], display: ['Space Grotesk', 'sans-serif'] },
                    colors: {
                        glass: { dark: 'rgba(10, 10, 20, 0.6)', border: 'rgba(255, 255, 255, 0.15)' },
                        neon: { blue: '#4F46E5', purple: '#A855F7', cyan: '#06B6D4', green: '#10B981', red: '#EF4444' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background: #0f172a; color: white; overflow-x: hidden; }
        .ambient-bg { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 90% 90%, rgba(6, 182, 212, 0.05), transparent 40%); }
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-sidebar {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
        }
        .glass-input {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
        }
        .glass-input:focus { border-color: #06B6D4; outline: none; }
        
        .nav-link {
            display: flex; align-items: center; gap: 0.75rem;
            padding: 0.75rem 1rem; margin-bottom: 0.5rem;
            border-radius: 0.5rem; color: #94a3b8; transition: all 0.2s;
        }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-link.active { background: rgba(6, 182, 212, 0.1); color: #06B6D4; border-right: 3px solid #06B6D4; }

        tr:hover td { background: rgba(255,255,255,0.02); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">
    
    <div class="ambient-bg"></div>

    <!-- SIDEBAR -->
    <aside class="glass-sidebar w-64 flex-col hidden md:flex z-50">
        <div class="h-16 flex items-center px-6 border-b border-white/5">
            <span class="font-display font-bold text-xl tracking-tight">Admin<span class="text-neon-cyan">Console</span></span>
        </div>
        
        <nav class="flex-1 p-4 overflow-y-auto">
            <button onclick="switchTab('dashboard')" class="nav-link w-full active" id="btn-dashboard">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i> Dashboard
            </button>
            <button onclick="switchTab('courses')" class="nav-link w-full" id="btn-courses">
                <i data-lucide="library" class="w-5 h-5"></i> Courses
            </button>
            <button onclick="switchTab('hackathons')" class="nav-link w-full" id="btn-hackathons">
                <i data-lucide="trophy" class="w-5 h-5"></i> Hackathons
            </button>
            <button onclick="switchTab('requests')" class="nav-link w-full" id="btn-requests">
                <i data-lucide="message-square" class="w-5 h-5"></i> Requests
            </button>
            <button onclick="switchTab('discussions')" class="nav-link w-full" id="btn-discussions">
                <i data-lucide="message-circle" class="w-5 h-5"></i> Discussions
            </button>
            <button onclick="switchTab('users')" class="nav-link w-full" id="btn-users">
                <i data-lucide="users" class="w-5 h-5"></i> Manage Users
            </button>
            <button onclick="openBroadcastModal()" class="nav-link w-full text-neon-red/80 hover:text-neon-red">
                <i data-lucide="radio" class="w-5 h-5"></i> Broadcast
            </button>
        </nav>

        <div class="p-4 border-t border-white/5">
            <div class="flex items-center gap-3 p-3 rounded-xl bg-white/5">
                <div class="w-8 h-8 rounded-full bg-neon-cyan/20 flex items-center justify-center text-neon-cyan font-bold text-xs" id="admin-initials">
                    NS
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-bold text-white truncate" id="admin-user-display">Naseer</p>
                    <p class="text-xs text-gray-500 truncate">System Admin</p>
                </div>
                <button onclick="logout()" class="text-gray-400 hover:text-white"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
        </div>
    </aside>

    <!-- MOBILE SIDEBAR CONTENT (For Drawer) -->
    <div id="mobile-sidebar" class="fixed inset-0 z-40 bg-black/80 backdrop-blur-md hidden" onclick="toggleMobileSidebar()">
        <div class="w-64 h-full bg-[#0f172a] border-r border-white/10 p-4" onclick="event.stopPropagation()">
            <div class="h-16 flex items-center mb-6">
                <span class="font-display font-bold text-xl">Menu</span>
            </div>
            <nav class="space-y-2">
                 <button onclick="switchTab('dashboard'); toggleMobileSidebar()" class="nav-link w-full">Dashboard</button>
                 <button onclick="switchTab('courses'); toggleMobileSidebar()" class="nav-link w-full">Courses</button>
                 <button onclick="openBroadcastModal(); toggleMobileSidebar()" class="nav-link w-full text-neon-red">Broadcast Alert</button>
                 <button onclick="logout()" class="nav-link w-full mt-8 border-t border-white/10 pt-4">Logout</button>
            </nav>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 flex flex-col h-full overflow-hidden relative">
        
        <!-- Header -->
        <header class="h-16 border-b border-white/5 bg-black/10 backdrop-blur flex items-center justify-between px-6 shrink-0">
            <div class="flex items-center gap-4">
                <button class="md:hidden text-gray-400" onclick="toggleMobileSidebar()">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <h2 class="text-sm font-medium text-gray-400" id="page-title">Dashboard Overview</h2>
            </div>
            <a href="../index.html" class="glass-input px-3 py-1.5 rounded-full text-xs font-bold hover:bg-white/10 transition-colors flex items-center gap-2">
                Exit Console <i data-lucide="external-link" class="w-3 h-3"></i>
            </a>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-6 md:p-8">
            
            <!-- VIEW: DASHBOARD -->
            <div id="view-dashboard" class="space-y-6">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Stat 1 -->
                    <div class="glass-panel p-6 rounded-xl relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-neon-purple/10 rounded-full blur-xl group-hover:bg-neon-purple/20 transition-colors"></div>
                        <span class="text-gray-500 text-xs uppercase tracking-widest font-bold block mb-2">Total Modules</span>
                        <div class="flex justify-between items-end relative z-10">
                            <span id="stat-modules" class="text-4xl font-display font-bold text-white">0</span>
                            <i data-lucide="layers" class="text-neon-purple w-6 h-6"></i>
                        </div>
                    </div>
                     <!-- Stat 2 -->
                    <div class="glass-panel p-6 rounded-xl relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-neon-blue/10 rounded-full blur-xl group-hover:bg-neon-blue/20 transition-colors"></div>
                        <span class="text-gray-500 text-xs uppercase tracking-widest font-bold block mb-2">Total Videos</span>
                        <div class="flex justify-between items-end relative z-10">
                            <span id="stat-videos" class="text-4xl font-display font-bold text-white">0</span>
                            <i data-lucide="video" class="text-neon-blue w-6 h-6"></i>
                        </div>
                    </div>
                    <!-- Stat 3 -->
                    <div class="glass-panel p-6 rounded-xl relative overflow-hidden group">
                        <div class="absolute -right-4 -top-4 w-24 h-24 bg-neon-cyan/10 rounded-full blur-xl group-hover:bg-neon-cyan/20 transition-colors"></div>
                        <span class="text-gray-500 text-xs uppercase tracking-widest font-bold block mb-2">Pending (Stud / Req)</span>
                        <div class="flex justify-between items-end relative z-10">
                            <span id="stat-pending" class="text-4xl font-display font-bold text-white">0/0</span>
                            <i data-lucide="bell" class="text-neon-cyan w-6 h-6"></i>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-6 rounded-xl">
                    <h3 class="text-lg font-bold text-white mb-4">Recent Activity</h3>
                    <div id="dashboard-activity-list" class="space-y-4">
                        <div class="text-center py-4 text-gray-600 text-xs animate-pulse">Loading real-time events...</div>
                    </div>
                </div>
            </div>

            <!-- VIEW: COURSES -->
            <div id="view-courses" class="hidden space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white/5 p-4 rounded-xl border border-white/5">
                    <div class="relative w-full md:w-64">
                        <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-500"></i>
                        <input type="text" placeholder="Search modules..." class="bg-black/20 border border-white/10 rounded-lg pl-9 pr-4 py-2 text-sm text-white w-full focus:border-neon-cyan outline-none transition-colors">
                    </div>
                    <button onclick="openModal()" class="w-full md:w-auto bg-neon-blue hover:bg-neon-blue/80 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-neon-blue/20">
                        <i data-lucide="plus" class="w-4 h-4"></i> Create Module
                    </button>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden overflow-x-auto">
                    <table class="w-full text-sm min-w-[600px]">
                        <thead>
                            <tr class="text-gray-500 text-xs uppercase tracking-wider bg-white/5 border-b border-white/5">
                                <th class="py-4 px-6 font-medium">Course Details</th>
                                <th class="py-4 px-6 font-medium">Instructor</th>
                                <th class="py-4 px-6 font-medium">Status</th>
                                <th class="py-4 px-6 font-medium text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="courses-table-body" class="divide-y divide-white/5">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- VIEW: DISCUSSIONS -->
            <div id="view-discussions" class="hidden space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white/5 p-4 rounded-xl border border-white/5">
                    <h3 class="text-white font-bold text-lg">Platform Discussions</h3>
                    <p class="text-xs text-gray-500">Global view of all student interactions</p>
                </div>

                <div class="grid grid-cols-1 gap-4" id="admin-comments-list">
                    <!-- Injected -->
                </div>
            </div>
            <div id="view-requests" class="hidden space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white/5 p-4 rounded-xl border border-white/5">
                    <h3 class="text-white font-bold text-lg">Student Requests</h3>
                    <p class="text-xs text-gray-500">Click a request to manage student needs</p>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden overflow-x-auto">
                    <table class="w-full text-sm min-w-[600px]">
                        <thead>
                            <tr class="text-gray-500 text-xs uppercase tracking-wider bg-white/5 border-b border-white/5">
                                <th class="py-4 px-6 font-medium text-left">Student Info</th>
                                <th class="py-4 px-6 font-medium text-left">Subject / Topic</th>
                                <th class="py-4 px-6 font-medium text-left">Status</th>
                                <th class="py-4 px-6 font-medium text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="requests-table-body" class="divide-y divide-white/5">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div id="view-hackathons" class="hidden space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white/5 p-4 rounded-xl border border-white/5">
                    <h3 class="text-white font-bold">Hackathon Management</h3>
                    <button onclick="window.location.href='hackathon-editor.html'" class="w-full md:w-auto bg-neon-green hover:bg-neon-green/80 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-neon-green/20">
                        <i data-lucide="plus" class="w-4 h-4"></i> Create Hackathon
                    </button>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden overflow-x-auto">
                    <table class="w-full text-sm min-w-[600px]">
                        <thead>
                            <tr class="text-gray-500 text-xs uppercase tracking-wider bg-white/5 border-b border-white/5">
                                <th class="py-4 px-6 font-medium text-left">Hackathon Details</th>
                                <th class="py-4 px-6 font-medium text-left">Date</th>
                                <th class="py-4 px-6 font-medium text-left">Status</th>
                                <th class="py-4 px-6 font-medium text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="hackathons-table-body" class="divide-y divide-white/5">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="view-users" class="hidden space-y-6">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 bg-white/5 p-4 rounded-xl border border-white/5">
                    <h3 class="text-white font-bold text-lg">Student Management</h3>
                    <p class="text-xs text-gray-500">Approve or Reject new student registrations</p>
                </div>

                <div class="glass-panel rounded-xl overflow-hidden overflow-x-auto">
                    <table class="w-full text-sm min-w-[600px]">
                        <thead>
                            <tr class="text-gray-500 text-xs uppercase tracking-wider bg-white/5 border-b border-white/5">
                                <th class="py-4 px-6 font-medium text-left">Student Info</th>
                                <th class="py-4 px-6 font-medium text-left">Status</th>
                                <th class="py-4 px-6 font-medium text-left">Joined Date</th>
                                <th class="py-4 px-6 font-medium text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="divide-y divide-white/5">
                            <!-- Injected -->
                        </tbody>
                    </table>
                </div>
            </div>
    </main>
    
    <!-- Broadcast Modal -->
    <div id="broadcast-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="glass-panel bg-[#0f172a] w-full max-w-md rounded-2xl p-8 relative shadow-2xl border border-white/10">
            <button onclick="document.getElementById('broadcast-modal').classList.add('hidden')" class="absolute top-6 right-6 text-gray-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-xl font-display font-bold mb-4 text-white flex items-center gap-2">
                <i data-lucide="radio" class="w-5 h-5 text-neon-red"></i> Broadcast Alert
            </h2>
            <div class="space-y-4">
                <textarea id="broadcast-msg" rows="3" placeholder="Type your urgent message to all students..." class="w-full glass-input rounded p-3 text-sm"></textarea>
                <div class="flex justify-end gap-3">
                    <button class="px-4 py-2 rounded text-sm text-gray-400 hover:text-white" onclick="document.getElementById('broadcast-modal').classList.add('hidden')">Cancel</button>
                    <button onclick="sendBroadcast()" class="px-6 py-2 rounded bg-neon-red hover:bg-red-600 text-white text-sm font-bold shadow-lg shadow-red-500/20">Send Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Course Modal (Matches previous logic) -->
    <div id="course-modal" class="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm hidden flex items-center justify-center p-4">
        <div class="glass-panel bg-[#0f172a] w-full max-w-2xl rounded-2xl p-8 relative shadow-2xl border border-white/10 max-h-[90vh] overflow-y-auto">
            <button onclick="closeModal()" class="absolute top-6 right-6 text-gray-500 hover:text-white"><i data-lucide="x" class="w-6 h-6"></i></button>
            <h2 class="text-2xl font-display font-bold mb-6 text-white">Editor Console</h2>
            <form id="course-form" class="space-y-4">
                <input type="hidden" id="course-id">
                <div class="grid grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs text-gray-500 uppercase font-bold">Title</label>
                        <input type="text" id="title" class="w-full glass-input rounded p-2 text-sm">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs text-gray-500 uppercase font-bold">Category</label>
                        <input type="text" id="category" class="w-full glass-input rounded p-2 text-sm">
                    </div>
                </div>
                <!-- ... Rest of form reused from previous implementation ... -->
                 <div class="space-y-1">
                    <label class="text-xs text-gray-500 uppercase font-bold">Description</label>
                    <textarea id="description" rows="3" class="w-full glass-input rounded p-2 text-sm"></textarea>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                     <div class="space-y-1">
                        <label class="text-xs text-gray-500 uppercase font-bold">Instructor</label>
                        <input type="text" id="instructor" class="w-full glass-input rounded p-2 text-sm">
                    </div>
                     <div class="space-y-1">
                        <label class="text-xs text-gray-500 uppercase font-bold">Thumbnail URL</label>
                        <input type="text" id="thumbnail" class="w-full glass-input rounded p-2 text-sm">
                    </div>
                </div>

                <!-- Video List -->
                <div class="border-t border-white/10 pt-4 mt-4">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-sm font-bold text-gray-300">Videos & Notes</span>
                        <button type="button" onclick="addEditorVideoField()" class="text-xs text-neon-cyan hover:text-white">+ Add Lesson</button>
                    </div>
                    <div id="video-editor-list" class="space-y-3 max-h-48 overflow-y-auto pr-2 custom-scrollbar"></div>
                </div>

                <div class="pt-6 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="px-6 py-2 rounded text-sm text-gray-400 hover:text-white transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded bg-neon-blue hover:bg-neon-blue/80 text-white text-sm font-bold shadow-lg shadow-neon-blue/20">Save Module</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../frontend/js/config.js"></script>
    <script src="../frontend/js/notifications.js"></script>
    <script>
        // Auth Guard
        const adminToken = localStorage.getItem('adminToken');
        if (!adminToken) {
            window.location.href = 'login.html';
        }

        // Init
        lucide.createIcons();
        loadDashboardData();
        loadAdminCourses();

        async function loadDashboardData() {
            try {
                const coursesRes = await fetch(`${CONFIG.API_BASE_URL}/courses`);
                const requestsRes = await fetch(`${CONFIG.API_BASE_URL}/requests`, { headers: { 'Authorization': `Bearer ${adminToken}` } });
                const commentsRes = await fetch(`${CONFIG.API_BASE_URL}/comments/all`, { headers: { 'Authorization': `Bearer ${adminToken}` } });

                if (requestsRes.status === 401 || commentsRes.status === 401) {
                    localStorage.removeItem('adminToken');
                    window.location.href = 'login.html';
                    return;
                }

                const coursesData = await coursesRes.json();
                const requestsData = await requestsRes.json();
                const commentsData = await commentsRes.json();

                const courses = Array.isArray(coursesData) ? coursesData : [];
                const requests = Array.isArray(requestsData) ? requestsData : [];
                const comments = Array.isArray(commentsData) ? commentsData : [];

                // Stats Dashboard
                document.getElementById('stat-modules').innerText = courses.length;
                let totalVideos = 0;
                courses.forEach(c => totalVideos += (c.videos ? c.videos.length : 0));
                document.getElementById('stat-videos').innerText = totalVideos;
                
                // Fetch User Stats
                const usersRes = await fetch(`${CONFIG.API_BASE_URL}/users`, {
                     headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const users = await usersRes.json();
                const pendingStud = users.filter(u => u.status === 'Pending').length;
                const pendingReq = requests.filter(r => r.status === 'Pending').length;
                
                document.getElementById('stat-pending').innerText = `${pendingStud}/${pendingReq}`;

                // Update Sidebar Identity
                const adminName = localStorage.getItem('adminName') || 'Naseer';
                document.getElementById('admin-user-display').innerText = adminName;
                document.getElementById('admin-initials').innerText = adminName.substring(0,2).toUpperCase();

                // Activity Feed Build
                const events = [];
                
                // 1. Requests
                requests.forEach(r => events.push({
                    icon: 'message-square',
                    color: 'neon-cyan',
                    text: `${r.studentName} requested ${r.subject || 'Material'} notes`,
                    time: new Date(r.createdAt)
                }));

                // 2. Comments
                comments.forEach(c => events.push({
                    icon: 'message-circle',
                    color: 'neon-purple',
                    text: `${c.userName} posted a discussion`,
                    time: new Date(c.createdAt)
                }));

                // 3. Course Updates
                courses.forEach(c => events.push({
                    icon: 'edit-3',
                    color: 'neon-green',
                    text: `Module "${c.title}" updated`,
                    time: new Date(c.updatedAt || c.createdAt)
                }));

                // Sort by newest
                events.sort((a,b) => b.time - a.time);
                
                const list = document.getElementById('dashboard-activity-list');
                list.innerHTML = events.length ? '' : '<div class="text-center py-4 text-gray-600 text-xs">No activity yet.</div>';
                
                events.slice(0, 8).forEach(e => {
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-4 text-sm text-gray-400";
                    div.innerHTML = `
                        <i data-lucide="${e.icon}" class="w-4 h-4 text-${e.color}"></i>
                        <span class="truncate">${e.text}</span>
                        <span class="ml-auto text-[10px] opacity-50 whitespace-nowrap">${timeAgo(e.time)}</span>
                    `;
                    list.appendChild(div);
                });
                lucide.createIcons();

            } catch(err) { console.error("Dashboard data load failed", err); }
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y ago";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo ago";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d ago";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h ago";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m ago";
            return "Just now";
        }

        function switchTab(viewId) {
            // Hide all views explicitly
            const views = ['dashboard', 'courses', 'hackathons', 'requests', 'discussions', 'users'];
            views.forEach(v => {
                const el = document.getElementById(`view-${v}`);
                if(el) el.classList.add('hidden');
            });

            const currentView = document.getElementById(`view-${viewId}`);
            if(currentView) currentView.classList.remove('hidden');
            
            // Sidebar Active State
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            const btn = document.getElementById(`btn-${viewId}`);
            if(btn) btn.classList.add('active');
            
            let title = 'Dashboard Overview';
            if(viewId === 'courses') title = 'Course Management';
            if(viewId === 'hackathons') {
                title = 'Hackathon Management';
                loadAdminHackathons();
            }
            if(viewId === 'requests') {
                title = 'Note Requests';
                loadAdminRequests();
            }
            if(viewId === 'discussions') {
                title = 'Internal Discussions';
                loadAdminDiscussions();
            }
            if(viewId === 'users') {
                title = 'Manage Students';
                loadAdminUsers();
            }
            if(viewId === 'dashboard') {
                loadDashboardData();
            }
            document.getElementById('page-title').innerText = title;
        }

        function toggleMobileSidebar() {
            const el = document.getElementById('mobile-sidebar');
            el.classList.toggle('hidden');
        }

        async function loadAdminCourses() {
             try {
                const res = await fetch(`${CONFIG.API_BASE_URL}/courses`);
                const courses = await res.json();
                
                const tbody = document.getElementById('courses-table-body');
                tbody.innerHTML = '';
                
                courses.forEach(c => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 transition-colors";
                    tr.innerHTML = `
                        <td class="py-4 px-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded bg-white/10 overflow-hidden"><img src="${c.thumbnail}" class="w-full h-full object-cover"></div>
                                <span class="font-bold text-white">${c.title}</span>
                            </div>
                        </td>
                        <td class="py-4 px-6 text-gray-400">${c.instructor}</td>
                        <td class="py-4 px-6"><span class="px-2 py-1 rounded-full bg-neon-green/10 text-neon-green text-xs font-bold border border-neon-green/20">Active</span></td>
                        <td class="py-4 px-6 text-right">
                             <button onclick='openCourseEditor(${JSON.stringify(c)})' class="p-2 rounded hover:bg-white/10 text-gray-400 hover:text-white"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                             <button onclick="deleteCourse('${c.id || c._id}')" class="p-2 rounded hover:bg-neon-red/10 text-gray-400 hover:text-neon-red"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            } catch(e) {}
        }

        // Modal Logic
        function openModal() {
            window.location.href = 'editor.html';
        }
        
        function openCourseEditor(course) {
             const id = course.id || course._id;
             window.location.href = `editor.html?id=${id}`;
        }

        async function loadAdminHackathons() {
             try {
                const res = await fetch(`${CONFIG.API_BASE_URL}/hackathons`);
                const data = await res.json();
                const tbody = document.getElementById('hackathons-table-body');
                tbody.innerHTML = '';
                
                data.forEach(h => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 transition-colors";
                    const id = h.id || h._id;
                    tr.innerHTML = `
                        <td class="py-4 px-6">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-white">${h.title}</span>
                                <span class="text-[10px] text-gray-500">${h.organizer}</span>
                            </div>
                        </td>
                        <td class="py-4 px-6 text-gray-400 text-xs">${new Date(h.date).toLocaleDateString()}</td>
                        <td class="py-4 px-6"><span class="px-2 py-1 rounded-full bg-neon-cyan/10 text-neon-cyan text-[10px] font-bold border border-neon-cyan/20">${h.status}</span></td>
                        <td class="py-4 px-6 text-right">
                             <button onclick="window.location.href='hackathon-editor.html?id=${id}'" class="p-2 rounded hover:bg-white/10 text-gray-400 hover:text-white"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                             <button onclick="deleteHackathon('${id}')" class="p-2 rounded hover:bg-neon-red/10 text-gray-400 hover:text-neon-red"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            } catch(e) {}
        }

        async function deleteHackathon(id) {
             if(confirm("Delete this hackathon?")) {
                 let token = localStorage.getItem('adminToken') || '';
                 if(token.includes('Bearer ')) token = token.replace('Bearer ', '').trim();
                 
                 const headers = {};
                 if(token) headers['Authorization'] = `Bearer ${token}`;

                 await fetch(`${CONFIG.API_BASE_URL}/hackathons/${id}`, { 
                     method: 'DELETE',
                     headers: headers
                 });
                 loadAdminHackathons();
             }
        }

        // Delete Logic
        async function deleteCourse(id) {
             if(confirm("Delete this module?")) {
                 let token = localStorage.getItem('adminToken') || '';
                 if(token.includes('Bearer ')) token = token.replace('Bearer ', '').trim();

                 const headers = {};
                 if(token) headers['Authorization'] = `Bearer ${token}`;

                 await fetch(`${CONFIG.API_BASE_URL}/courses/${id}`, { 
                     method: 'DELETE',
                     headers: headers
                 });
                 loadAdminCourses();
             }
        }

         // Broadcast Logic
         function openBroadcastModal() {
            document.getElementById('broadcast-modal').classList.remove('hidden');
            document.getElementById('broadcast-msg').value = '';
        }
        async function sendBroadcast() {
            const msg = document.getElementById('broadcast-msg').value;
             if(msg) {
                let token = localStorage.getItem('adminToken') || '';
                if(token.includes('Bearer ')) token = token.replace('Bearer ', '').trim();
                
                try {
                    const res = await fetch(`${CONFIG.API_BASE_URL}/alerts`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ message: msg })
                    });
                    
                    if(res.ok) {
                        alert("Broadcast sent successfully!");
                        document.getElementById('broadcast-modal').classList.add('hidden');
                    }
                } catch(e) { console.error(e); }
            }
        }
        async function loadAdminRequests() {
             try {
                const res = await fetch(`${CONFIG.API_BASE_URL}/requests`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const data = await res.json();
                const tbody = document.getElementById('requests-table-body');
                tbody.innerHTML = '';
                
                data.forEach(r => {
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 transition-colors";
                    const id = r.id || r._id;
                    const statusClass = r.status === 'Pending' ? 'bg-neon-blue/10 text-neon-blue' : 'bg-neon-green/10 text-neon-green';
                    
                    tr.innerHTML = `
                        <td class="py-4 px-6">
                            <div class="flex flex-col">
                                <span class="font-bold text-white">${r.studentName}</span>
                                <span class="text-[10px] text-gray-500">${new Date(r.createdAt).toLocaleString()}</span>
                            </div>
                        </td>
                        <td class="py-4 px-6">
                             <div class="flex flex-col">
                                <span class="text-white font-medium">${r.subject}</span>
                                <p class="text-[10px] text-gray-500 line-clamp-1">${r.topic}</p>
                             </div>
                        </td>
                        <td class="py-4 px-6"><span class="px-2 py-1 rounded-full ${statusClass} text-[10px] font-bold border border-white/5">${r.status}</span></td>
                        <td class="py-4 px-6 text-right text-gray-400 no-wrap">
                             <button onclick="updateRequestStatus('${id}', 'Fulfilled')" class="p-2 rounded hover:bg-neon-green/10 hover:text-neon-green" title="Mark as Fulfilled"><i data-lucide="check-circle" class="w-4 h-4"></i></button>
                             <button onclick="deleteRequest('${id}')" class="p-2 rounded hover:bg-neon-red/10 hover:text-neon-red" title="Dismiss Request"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
                lucide.createIcons();
            } catch(e) {}
        }

        async function updateRequestStatus(id, status) {
            let token = localStorage.getItem('adminToken') || '';
            if(token.includes('Bearer ')) token = token.replace('Bearer ', '').trim();
            
            await fetch(`${CONFIG.API_BASE_URL}/requests/${id}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status })
            });
            loadAdminRequests();
        }

        async function deleteRequest(id) {
            if(confirm("Dismiss this request?")) {
                let token = localStorage.getItem('adminToken') || '';
                if(token.includes('Bearer ')) token = token.replace('Bearer ', '').trim();
                
                await fetch(`${CONFIG.API_BASE_URL}/requests/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadAdminRequests();
            }
        }

        async function loadAdminDiscussions() {
            try {
                // Fetching all comments requires a new route or query, assuming we can get them all via /api/comments/all
                // Let's create a route for 'all' in the backend later, or just pull based on course.
                // For now, let's fetch all 
                const res = await fetch(`${CONFIG.API_BASE_URL}/comments/all`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('adminToken')}` }
                });
                const comments = await res.json();
                const container = document.getElementById('admin-comments-list');
                container.innerHTML = '';

                comments.forEach(c => {
                    const div = document.createElement('div');
                    div.className = "glass-panel p-6 rounded-xl border border-white/5 hover:bg-white/10 transition-all";
                    div.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-neon-purple/20 flex items-center justify-center text-neon-purple font-bold">
                                    ${c.userName[0]}
                                </div>
                                <div>
                                    <h4 class="text-white font-bold">${c.userName}</h4>
                                    <p class="text-[10px] text-gray-500">${new Date(c.createdAt).toLocaleString()}</p>
                                </div>
                            </div>
                            <button onclick="deleteAdminComment('${c._id || c.id}')" class="text-gray-500 hover:text-neon-red transition-colors p-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <p class="text-gray-400 text-sm italic mb-3">Topic: ${c.videoId}</p>
                        <p class="text-gray-200">${c.text}</p>
                    `;
                    container.appendChild(div);
                });
                lucide.createIcons();
            } catch(e) {}
        }

        async function deleteAdminComment(id) {
            if(confirm("Delete this discussion post?")) {
                let token = localStorage.getItem('adminToken') || '';
                if(token.includes('Bearer ')) token = token.replace('Bearer ', '').trim();
                
                await fetch(`${CONFIG.API_BASE_URL}/comments/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                loadAdminDiscussions();
            }
        }

        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminName');
            window.location.href = 'login.html';
        }

        async function loadAdminUsers() {
            try {
                let token = localStorage.getItem('adminToken') || '';
                if(token.includes('Bearer ')) token = token.replace('Bearer ', '').trim();

                const res = await fetch(`${CONFIG.API_BASE_URL}/users`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const users = await res.json();
                
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';

                users.forEach(u => {
                    const statusClass = u.status === 'Approved' ? 'bg-neon-green/10 text-neon-green' : 
                                      u.status === 'Pending' ? 'bg-yellow-500/10 text-yellow-500' : 'bg-red-500/10 text-red-500';
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-white/5 transition-colors";
                    tr.innerHTML = `
                        <td class="py-4 px-6">
                            <div class="font-bold text-white">${u.name}</div>
                            <div class="text-xs text-gray-500">${u.email}</div>
                        </td>
                        <td class="py-4 px-6">
                            <span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${statusClass}">${u.status}</span>
                        </td>
                        <td class="py-4 px-6 text-gray-400 text-xs">
                            ${new Date(u.createdAt).toLocaleDateString()}
                        </td>
                        <td class="py-4 px-6 text-right space-x-2">
                            ${u.status !== 'Approved' ? `
                                <button onclick="updateUserStatus('${u._id}', 'Approved')" class="text-neon-green hover:underline text-xs">Approve</button>
                            ` : ''}
                            ${u.status !== 'Rejected' ? `
                                <button onclick="updateUserStatus('${u._id}', 'Rejected')" class="text-red-500 hover:underline text-xs">Reject</button>
                            ` : ''}
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            } catch (err) { console.error(err); }
        }

        async function updateUserStatus(userId, status) {
            try {
                let token = localStorage.getItem('adminToken') || '';
                if(token.includes('Bearer ')) token = token.replace('Bearer ', '').trim();

                const res = await fetch(`${CONFIG.API_BASE_URL}/users/${userId}/status`, {
                    method: 'PUT',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ status })
                });
                if (res.ok) loadAdminUsers();
            } catch (err) { console.error(err); }
        }
    </script>
</body>
</html>
